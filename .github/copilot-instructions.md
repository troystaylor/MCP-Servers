# Copilot Instructions — MCP Servers Workspace

## Contents

- General Guidelines
- SDK Update Checklist
- Microsoft Agent 365 Integration

---

## General Guidelines

- This workspace uses **pnpm** as its package manager. Never use `npm` or `yarn`.
- Node.js **>=20** is required.
- The MCP TypeScript SDK lives in `typescript-sdk/` and is a **monorepo** managed via pnpm workspaces.
- Each MCP server project gets its own directory at the workspace root (e.g., `my-api-server/`).
- Prefer the patterns and conventions already established in this codebase when making changes.
- **API documentation first**: When implementing tools that call 3rd party APIs, always fetch and reference the **official API documentation** (OpenAPI specs, developer docs, reference pages) for endpoint URLs, parameters, response shapes, auth headers, and error codes. Never rely on general knowledge or training data for API details — APIs change frequently and training data goes stale. Use `fetch_webpage` or the browser to retrieve current docs when building or updating a server.
- **TypeScript conventions** for `src/**/*.ts` files are in `.github/instructions/typescript-server.instructions.md`.
- **Config file conventions** for `package.json` / `tsconfig.json` are in `.github/instructions/config-files.instructions.md`.
- The **Microsoft 365 Agents Toolkit** VS Code extension (`TeamsDevApp.ms-teams-vscode-extension`) is installed. Use it for creating, debugging, and deploying agents that consume MCP servers — including declarative agents, custom engine agents, and Teams bots. CLI: `@microsoft/m365agentstoolkit-cli`.

## SDK Update Checklist

When prompted to update the SDK, or periodically during development sessions, run these steps from `typescript-sdk/`:

1. **Sync with upstream:**
   ```bash
   git fetch upstream
   git merge upstream/main --no-edit
   ```
   If the `upstream` remote is not configured, add it first:
   ```bash
   git remote add upstream https://github.com/modelcontextprotocol/typescript-sdk.git
   ```

2. **Check for new releases:**
   Visit or fetch tags from upstream to see if a new version has been published:
   ```bash
   git fetch upstream --tags
   git log --oneline upstream/main..HEAD
   ```

3. **Install dependencies after sync:**
   ```bash
   pnpm install
   ```

4. **Run tests to verify nothing is broken:**
   ```bash
   pnpm test
   ```

5. **Review the changelog / changeset:**
   Check the `.changeset/` directory and any `CHANGELOG.md` files for breaking changes or new features that may affect downstream MCP servers built on this SDK.

### Reminder Cadence

- **Remind the user to sync with upstream** at the start of each new coding session involving the SDK.
- If it has been more than a week since the last sync (check `git log --oneline -1 upstream/main`), proactively suggest running the update steps above.

## Microsoft Agent 365 Integration

MCP servers built in this workspace are **custom servers wrapping 3rd party APIs** and may be deployed as **Agent 365 tooling servers** — enterprise-grade MCP servers governed through the Microsoft 365 admin center.

### Key Packages

When building servers intended for Agent 365, these npm packages provide enterprise capabilities (all currently `0.1.0-preview.*`):

#### `@microsoft/agents-a365-tooling`
Core MCP tool server management: discovery, registration, and lifecycle.
- `McpToolServerConfigurationService` — reads `ToolingManifest.json` to list available tool servers.
- `addToolServersToAgent()` — registers all MCP servers from the manifest with your orchestrator.
- The `ToolingManifest.json` is generated by the Agent 365 CLI (`a365 develop add-mcp-servers`) and contains `mcpServerName`, `mcpServerUniqueName`, `scope`, and `audience` per server.
- Use the **mock tooling server** (`a365 develop start-mock-tooling-server`) for offline local development. Set `MCP_PLATFORM_ENDPOINT=http://localhost:5309`.
- Docs: https://learn.microsoft.com/microsoft-agent-365/developer/tooling?tabs=nodejs

#### `@microsoft/agents-a365-runtime`
Authentication (Entra-backed agent identity), authorization, and Power Platform API discovery.
- Provides `getObservabilityAuthenticationScope()` for obtaining auth tokens for observability.
- Supports **agentic authentication** (agent has its own identity) and **OBO (On-Behalf-Of)** delegated user permissions.
- Agent registration creates an agentic app ID and agentic user for authentication.
- A one-time tenant setup with `New-Agent365ToolsServicePrincipalProdPublic.ps1` (requires Global Admin) is needed.
- Docs: https://learn.microsoft.com/microsoft-agent-365/developer/?tabs=nodejs

#### `@microsoft/agents-a365-observability`
OpenTelemetry-based tracing for tool executions and AI model inference, with Azure Monitor integration.
- `ObservabilityManager.configure()` — builder pattern for setup: `.withService(name, version)`, `.withTokenResolver(fn)`, `.withConsoleExporter(true)`.
- Three instrumentation scopes: `InvokeAgentScope`, `ExecuteToolScope`, `InferenceScope` — each with `.start()`, `.recordError()`, and scope-specific recording methods.
- `BaggageBuilder` — sets contextual attributes (tenantId, agentId, correlationId) that flow through all spans.
- Auto-instrumentation for OpenAI via `@microsoft/agents-a365-observability-extensions-openai`.
- Environment variables: `ENABLE_OBSERVABILITY=true`, `ENABLE_A365_OBSERVABILITY_EXPORTER=true`.
- Required for store publishing — all three scopes must emit required telemetry attributes.
- Docs: https://learn.microsoft.com/microsoft-agent-365/developer/observability?tabs=nodejs

#### `@microsoft/agents-a365-notifications`
Notification services for email, Word/Excel/PowerPoint comments, and agent lifecycle events.
- `AgentNotificationActivity` — parsed notification with strongly-typed data (`emailNotification`, `wpxCommentNotification`).
- `NotificationType` enum: `EmailNotification`, `WpxComment`, `AgentLifecycleNotification`.
- Handlers: `onAgentNotification('*', ...)`, `onAgenticEmailNotification(...)`, `onAgenticWordNotification(...)`, `onAgenticExcelNotification(...)`, `onAgenticPowerPointNotification(...)`.
- Lifecycle handlers: `onLifecycleNotification(...)`, `onAgenticUserCreatedNotification(...)`, `onAgenticUserWorkloadOnboardingNotification(...)`, `onAgenticUserIdentityDeletedNotification(...)`.
- Supports handler priority ranking and auto sign-in configuration.
- Docs: https://learn.microsoft.com/microsoft-agent-365/developer/notification?tabs=nodejs

#### Framework Extensions
For consuming MCP servers from AI agents:
- `@microsoft/agents-a365-tooling-extensions-openai` — OpenAI Agents integration.
- `@microsoft/agents-a365-tooling-extensions-claude` — Anthropic Claude integration.
- `@microsoft/agents-a365-tooling-extensions-langchain` — LangChain integration (`McpToolRegistrationService` + `addToolServersToAgent()`).

### Enterprise Considerations

When designing MCP servers for Agent 365 deployment:
- Tools must be **granular and auditable** — each tool call is traced via Microsoft Defender.
- Use **scoped permissions** — grant only the access the agent needs (Entra scopes).
- Support **On-Behalf-Of (OBO) delegated user permissions** or agentic user identity for authentication.
- Servers are governed centrally — IT admins can allow or block servers in the M365 admin center.
- Available M365 MCP servers (Mail, Calendar, Teams, SharePoint, Word, Dataverse, User Profile, Copilot Search) exist but are **not used in this workspace** — we build custom servers for 3rd party APIs. Be aware of them to avoid duplicating functionality if an agent composes multiple servers.
- Add **observability** with `InvokeAgentScope`, `ExecuteToolScope`, and `InferenceScope` — all three are required for store publishing.
- Use **`BaggageBuilder`** to propagate `tenantId`, `agentId`, and `correlationId` across all spans.
- Handle **notifications** (email, Word/Excel/PowerPoint comments, lifecycle events) when agents need to react to M365 collaboration activities.
- Use the **Agent 365 CLI** (`a365 develop`) for server discovery, manifest generation, and mock testing.

### M365 MCP Server Catalog

Microsoft provides pre-certified MCP servers for core M365 services. These are **not used in this workspace** — we build custom servers for 3rd party APIs. Listed here for reference so custom tools avoid duplicating built-in functionality when agents compose multiple servers:

| Server | Example tools |
|--------|---------------|
| **Copilot Search** | Chat with M365 Copilot, multi-turn threads, file-grounded responses |
| **Outlook Mail** | `createMessage`, reply, reply-all, semantic search |
| **Outlook Calendar** | `getEvents`, create/update/delete events, accept/decline, conflict resolution |
| **Teams** | Create/update chat, add members, post messages, channel operations |
| **SharePoint & OneDrive** | Upload files, get metadata, search, manage lists |
| **Word** | Create/read documents, add comments, reply to comments |
| **Dataverse & Dynamics 365** | CRUD operations, domain-specific actions |
| **User Profile** | Get manager, direct reports, profile info, search users |

The catalog also supports **ISV servers** and custom line-of-business servers, all governed through the tooling gateway.

### MCP Certification

> **Note**: The certification process is evolving as more MCP servers are officially certified. Details below are preliminary and subject to change.

To publish a custom MCP server for broad availability in M365/Copilot, it must pass Microsoft's **MCP certification process**:

1. **Publisher eligibility** — Verified publisher via Microsoft Partner Center with completed business verification and enrollment in the M365 and Copilot program.
2. **Authentication** — Must support OAuth 2.0 (preferred), API key, or Basic Auth. Provide test credentials for validation.
3. **Packaging** — Package as a Power Platform connector: OpenAPI definition, auth config, metadata (name, description, categories, icons), and an `intro.md` file documenting purpose, tools, setup, and limitations.
4. **Submission** — Submit through Partner Center under "Microsoft 365 and Copilot – Power Platform Connector".
5. **Automated validation** — Schema correctness, metadata completeness, packaging integrity, policy compliance.
6. **Manual review** — Functionality, security, compliance, telemetry, and responsible AI readiness testing.
7. **Responsible AI evaluation** — Safety testing across normal, edge-case, and adversarial scenarios.
8. **Deployment** — Certified servers are deployed across all supported regions.

**Post-certification**: Keep the server aligned with its certified definition, resubmit for new tools or significant changes, maintain docs, and monitor telemetry.

- Current certified servers: https://learn.microsoft.com/en-us/connectors/connector-reference/connector-reference-mcpserver-connectors
- Certification docs: https://learn.microsoft.com/en-us/microsoft-agent-365/mcp-certification

### MCP Management Server

The Agent 365 **MCP Management Server** is an API-first surface for creating and managing custom MCP servers. Connect to it in VS Code:
1. Ctrl+Shift+P → "MCP: Add Server" → select `http`
2. URL: `https://agent365.svc.cloud.microsoft/mcp/environments/{environment ID}/servers/MCPManagement`
3. Use built-in tools like `CreateMCPServer`, `CreateToolWithConnector`, `UpdateTool`, `DeleteMCPServer`, and `PublishMCPServer`.
4. Supports 1,500+ connectors (ServiceNow, JIRA, etc.), Microsoft Graph APIs, Dataverse custom APIs, and arbitrary REST endpoints as tool backends.

### Azure Deployment

MCP servers in this workspace deploy to Azure using a **hybrid model**:

- **Azure Container Apps** (primary) — for stateful servers that need persistent sessions, long-running connections, or complex dependencies. Deploy with `azd up` using a Dockerfile + `azure.yaml`. Use `NodeStreamableHTTPServerTransport` (from `@modelcontextprotocol/node`) with Express and session-to-transport mapping.
- **Azure Functions — Flex Consumption** (alternative) — for lightweight stateless servers where scale-to-zero matters. Deploy SDK-built servers as custom handlers with zero code changes— just add `host.json` with `"configurationProfile": "mcp-custom-handler"`. Built-in App Service auth implements the MCP authorization spec automatically. Constraint: stateless streamable-http only.

Container Apps is the default choice because our servers wrap 3rd party APIs that often require stateful sessions.

### MCP Authorization

When deploying servers remotely over HTTP, implement OAuth 2.1 authorization per the [MCP authorization spec](https://modelcontextprotocol.io/specification/latest/basic/authorization):

- Serve a **Protected Resource Metadata (PRM)** document at `/.well-known/oauth-protected-resource` — implement a route returning JSON with `resource`, `authorization_servers`, and `scopes_supported`.
- Return `401 Unauthorized` with `WWW-Authenticate: Bearer` header including `resource_metadata` URI.
- Implement bearer token validation middleware — verify tokens via introspection or JWT library; always check `aud` matches the server URL. See `typescript-sdk/examples/shared/src/authMiddleware.ts` for a reference implementation (demo-only, not production-ready).
- Validate tokens via introspection or JWT verification; always check `aud` matches the server URL.
- Define **scoped permissions** per tool/capability (e.g., `mcp:tools`, `mcp:resources`).
- Support **Dynamic Client Registration (DCR)** or document pre-registration steps.
- Use short-lived access tokens, enforce HTTPS in production, never log tokens or secrets.
- Authorization is **not needed for stdio** (local transport) — use env-based credentials instead.
- Docs: https://modelcontextprotocol.io/docs/tutorials/security/authorization
